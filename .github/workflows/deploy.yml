name: Deploy to Yandex Serverless

# üöÄ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ push –≤ production –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –∏–∑ UI
on:
  push:
    branches: [ production ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –≤ YC CLI
      - name: Authenticate to Yandex Cloud
        uses: yc-actions/cli-authenticate@v1
        with:
          service-account-key: ${{ secrets.YC_SA_KEY }}   # –ø–æ–ª–Ω—ã–π JSON-–∫–ª—é—á

      # 3. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Container Registry
      - name: Docker login to YCR
        run: |
          echo '${{ secrets.YC_SA_KEY }}' \
            | docker login --username oauth --password-stdin '${{ secrets.YC_REGISTRY }}'

      # 4. –°–±–æ—Ä–∫–∞ –∏ push –æ–±—Ä–∞–∑–∞
      - name: Build & push image
        env:
          IMAGE: '${{ secrets.YC_REGISTRY }}/${{ secrets.YC_REPOSITORY }}:${{ github.sha }}'
        run: |
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      # 5. –î–µ–ø–ª–æ–π –≤ Serverless Containers
      - name: Deploy to Serverless Containers
        uses: yc-actions/yc-sls-container-deploy@v2
        with:
          folder-id:      ${{ secrets.YC_FOLDER_ID }}
          container-name: vkPalmAi
          image-url:      '${{ secrets.YC_REGISTRY }}/${{ secrets.YC_REPOSITORY }}:${{ github.sha }}'
          memory:         512   # –ú–ë
          timeout:        30    # —Å–µ–∫
